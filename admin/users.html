<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Users - VarnWear Admin</title>

    <link rel="stylesheet" href="../css/global.css" />
    <link rel="stylesheet" href="../css/admin.css" />

    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Dosis:wght@200..800&display=swap"
      rel="stylesheet"
    />

    <!-- INLINE FIX CSS (you can move this to admin.css later) -->
    <style>
      .user-details-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-top: 1rem;
      }

      .order-detail-section {
        background: #f5f5f5;
        padding: 1.25rem;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
      }

      .order-detail-section h4 {
        margin-bottom: 0.75rem;
        color: #d4af37;
      }

      .order-detail-section.full-width {
        grid-column: span 2;
      }

      @media (max-width: 768px) {
        .user-details-grid {
          grid-template-columns: 1fr;
        }

        .order-detail-section.full-width {
          grid-column: span 1;
        }
      }
    </style>
  </head>

  <body class="admin-body">
    <!-- Admin Navbar -->
    <nav class="admin-navbar">
      <div class="container">
        <a href="index.html" class="navbar-brand">VarnWear Admin</a>
        <ul class="admin-menu">
          <li><a href="index.html">Dashboard</a></li>
          <li><a href="products.html">Products</a></li>
          <li><a href="orders.html">Orders</a></li>
          <li><a href="users.html" class="active">Users</a></li>
        </ul>
        <button class="btn btn-outline btn-small" onclick="adminLogout()">
          Logout
        </button>
      </div>
    </nav>

    <!-- Users Content -->
    <div class="admin-container">
      <h1 class="mb-4">Manage Users</h1>

      <div class="admin-table-container">
        <table class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Registered</th>
              <th>Orders</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTable">
            <tr>
              <td colspan="6" class="text-center">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- User Details Modal -->
    <div class="modal" id="userModal">
      <div class="modal-content" style="max-width: 900px">
        <span class="modal-close" onclick="closeUserModal()">&times;</span>
        <h2>User Details</h2>
        <div id="userDetails">
          <div class="user-modal-grid">
            <!-- LEFT COLUMN -->
            <div class="user-column">
              <div class="order-detail-section">
                <!-- Personal Information -->
              </div>

              <div class="order-detail-section">
                <!-- Order Summary -->
              </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="user-column">
              <div class="order-detail-section">
                <!-- Recent Orders -->
              </div>

              <div class="order-detail-section">
                <!-- Last Shipping Address -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="../js/api.js"></script>
  <script src="../js/admin-auth.js"></script>
    
    <script src="../js/orders.js"></script>
    <script src="../js/utils.js"></script>

    <script>
      if (!requireAdminAuth()) {
      }

      document.addEventListener("DOMContentLoaded", loadUsers);

      async function loadUsers() {
        const response = await fetch('http://localhost:3000/api/admin/users');
        const users = await response.json();
        const tbody = document.getElementById("usersTable");

        if (!users.length) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center">No users found</td></tr>`;
          return;
        }

        tbody.innerHTML = users
          .map((user) => {
            const orders = getAllOrders().filter((o) => o.userId === user.id);
            return `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.firstName} ${user.lastName}</td>
                    <td>${user.email}</td>
                    <td>${formatDate(user.createdAt)}</td>
                    <td>${orders.length}</td>
                    <td>
                        <button class="btn btn-small btn-outline" onclick="viewUser('${
                          user.id
                        }')">View</button>
                    </td>
                </tr>
            `;
          })
          .join("");
      }

      async function viewUser(userId) {
        const response = await fetch('http://localhost:3000/api/admin/users');
        const users = await response.json();
        const user = users.find((u) => u.id === userId || u._id === userId);
        const orders = getAllOrders().filter((o) => o.userId === userId);

        document.getElementById("userDetails").innerHTML = `
        <div class="user-modal-grid">

            <!-- LEFT -->
            <div class="user-column">
                <div class="order-detail-section">
                    <h4>Personal Information</h4>
                    <p><strong>Name:</strong> ${user.firstName} ${
          user.lastName
        }</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>Phone:</strong> ${
                      user.phone || "Not provided"
                    }</p>
                    <p><strong>Registered:</strong> ${formatDate(
                      user.createdAt
                    )}</p>
                </div>

                <div class="order-detail-section">
                    <h4>Order Summary</h4>
                    <p><strong>Total Orders:</strong> ${orders.length}</p>
                    <p><strong>Total Spent:</strong> ₹${orders
                      .reduce((s, o) => s + o.total, 0)
                      .toLocaleString()}</p>
                </div>
            </div>

            <!-- RIGHT -->
            <div class="user-column">
                <div class="order-detail-section scroll-box">
                    <h4>Recent Orders</h4>
                    ${
                      orders.length
                        ? orders
                            .slice(0, 5)
                            .map(
                              (o) => `
                        <div class="order-row">
                            <span>${o.id}</span>
                            <span class="status-badge status-${o.status}">${
                                o.status
                              }</span>
                            <span>₹${o.total.toLocaleString()}</span>
                        </div>
                    `
                            )
                            .join("")
                        : "<p>No orders</p>"
                    }
                </div>

                ${
                  orders[0]?.shippingAddress
                    ? `
                <div class="order-detail-section">
                    <h4>Last Shipping Address</h4>
                    <p>${orders[0].shippingAddress.address}</p>
                    <p>${orders[0].shippingAddress.city}, ${orders[0].shippingAddress.state}</p>
                    <p>PIN: ${orders[0].shippingAddress.pinCode}</p>
                    <p>Phone: ${orders[0].shippingAddress.phone}</p>
                </div>
                `
                    : ""
                }
            </div>

        </div>
    `;

        document.getElementById("userModal").classList.add("show");
      }

      function closeUserModal() {
        document.getElementById("userModal").classList.remove("show");
      }
    </script>
  </body>
</html>
